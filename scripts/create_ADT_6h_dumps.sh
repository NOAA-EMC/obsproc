#!/bin/bash

#/lfs/h1/ops/prod/dcom/20231020/wgrdbul/adt:
#total 48916
#-rwxrwxr-x 1 dfprod prod     153 Oct 20 00:35 '^rads_adt.*293.nc$'
#-rw-rw-r-- 1 dfprod prod 6892416 Oct 20 21:35  rads_adt_ncoda_6a_2023293.nc
#-rw-rw-r-- 1 dfprod prod 6412180 Oct 20 21:35  rads_adt_ncoda_j3_2023293.nc
#-rw-rw-r-- 1 dfprod prod 7177280 Oct 20 22:35  rads_adt_ncoda_3a_2023293.nc
#-rw-rw-r-- 1 dfprod prod 6988192 Oct 20 22:35  rads_adt_ncoda_3b_2023293.nc
#-rw-rw-r-- 1 dfprod prod 6814632 Oct 20 22:35  rads_adt_ncoda_c2_2023293.nc
#-rw-rw-r-- 1 dfprod prod 5175712 Oct 20 23:35  rads_adt_ncoda_sa_2023293.nc
#-rw-rw-r-- 1 dfprod prod 1756316 Oct 23 00:36  rads_adt_3a_2023293.nc
#-rw-rw-r-- 1 dfprod prod 1771376 Oct 23 00:36  rads_adt_3b_2023293.nc
#-rw-rw-r-- 1 dfprod prod 1375548 Oct 23 00:36  rads_adt_c2_2023293.nc
#-rw-rw-r-- 1 dfprod prod 2032796 Oct 23 00:36  rads_adt_6a_2023293.nc
#-rw-rw-r-- 1 dfprod prod 1989424 Oct 23 00:36  rads_adt_j3_2023293.nc
#-rw-rw-r-- 1 dfprod prod 1678248 Oct 23 00:36  rads_adt_sa_2023293.nc
#
#/lfs/h1/ops/prod/dcom/20231021/wgrdbul/adt:
#total 46444
#-rwxrwxr-x 1 dfprod prod     153 Oct 21 00:35 '^rads_adt.*294.nc$'
#-rw-rw-r-- 1 dfprod prod 6427020 Oct 21 21:35  rads_adt_ncoda_3a_2023294.nc
#-rw-rw-r-- 1 dfprod prod 6471744 Oct 21 21:35  rads_adt_ncoda_3b_2023294.nc
#-rw-rw-r-- 1 dfprod prod 6736312 Oct 21 21:35  rads_adt_ncoda_6a_2023294.nc
#-rw-rw-r-- 1 dfprod prod 6700716 Oct 21 21:35  rads_adt_ncoda_j3_2023294.nc
#-rw-rw-r-- 1 dfprod prod 5479448 Oct 21 22:35  rads_adt_ncoda_c2_2023294.nc
#-rw-rw-r-- 1 dfprod prod 5368976 Oct 21 22:35  rads_adt_ncoda_sa_2023294.nc
#-rw-rw-r-- 1 dfprod prod 1779756 Oct 24 00:37  rads_adt_3a_2023294.nc
#-rw-rw-r-- 1 dfprod prod 1842496 Oct 24 00:37  rads_adt_3b_2023294.nc
#-rw-rw-r-- 1 dfprod prod 1990756 Oct 24 00:37  rads_adt_6a_2023294.nc
#-rw-rw-r-- 1 dfprod prod 1295548 Oct 24 00:37  rads_adt_c2_2023294.nc
#-rw-rw-r-- 1 dfprod prod 2054024 Oct 24 00:37  rads_adt_j3_2023294.nc
#-rw-rw-r-- 1 dfprod prod 1382368 Oct 24 00:37  rads_adt_sa_2023294.nc
#
#/lfs/h1/ops/prod/dcom/20231022/wgrdbul/adt:
#total 47144
#-rwxrwxr-x 1 dfprod prod     153 Oct 22 00:35 '^rads_adt.*295.nc$'
#-rw-rw-r-- 1 dfprod prod 6910524 Oct 22 21:35  rads_adt_ncoda_3a_2023295.nc
#-rw-rw-r-- 1 dfprod prod 6792688 Oct 22 21:35  rads_adt_ncoda_3b_2023295.nc
#-rw-rw-r-- 1 dfprod prod 7066072 Oct 22 21:35  rads_adt_ncoda_6a_2023295.nc
#-rw-rw-r-- 1 dfprod prod 6111796 Oct 22 21:35  rads_adt_ncoda_j3_2023295.nc
#-rw-rw-r-- 1 dfprod prod 6339716 Oct 22 22:35  rads_adt_ncoda_c2_2023295.nc
#-rw-rw-r-- 1 dfprod prod 4729664 Oct 22 22:35  rads_adt_ncoda_sa_2023295.nc
#-rw-rw-r-- 1 dfprod prod 1824556 Oct 24 00:36  rads_adt_3a_2023295.nc
#-rw-rw-r-- 1 dfprod prod 1757936 Oct 24 00:36  rads_adt_3b_2023295.nc
#-rw-rw-r-- 1 dfprod prod 2048796 Oct 24 00:36  rads_adt_6a_2023295.nc
#-rw-rw-r-- 1 dfprod prod 1367388 Oct 24 00:36  rads_adt_c2_2023295.nc
#-rw-rw-r-- 1 dfprod prod 2033504 Oct 24 00:36  rads_adt_j3_2023295.nc
#-rw-rw-r-- 1 dfprod prod 1261328 Oct 24 00:36  rads_adt_sa_2023295.nc
#
#/lfs/h1/ops/prod/dcom/20231023/wgrdbul/adt:
#total 44768
#-rwxrwxr-x 1 dfprod prod     153 Oct 23 00:35 '^rads_adt.*296.nc$'
#-rw-rw-r-- 1 dfprod prod 6737476 Oct 23 21:35  rads_adt_ncoda_3a_2023296.nc
#-rw-rw-r-- 1 dfprod prod 6707532 Oct 23 21:35  rads_adt_ncoda_3b_2023296.nc
#-rw-rw-r-- 1 dfprod prod 7034420 Oct 23 21:35  rads_adt_ncoda_6a_2023296.nc
#-rw-rw-r-- 1 dfprod prod 6748328 Oct 23 21:35  rads_adt_ncoda_j3_2023296.nc
#-rw-rw-r-- 1 dfprod prod 6108072 Oct 23 22:35  rads_adt_ncoda_c2_2023296.nc
#-rw-rw-r-- 1 dfprod prod 4588120 Oct 23 22:35  rads_adt_ncoda_sa_2023296.nc
#-rw-rw-r-- 1 dfprod prod 1398956 Oct 24 00:35  rads_adt_3a_2023296.nc
#-rw-rw-r-- 1 dfprod prod 1318696 Oct 24 00:35  rads_adt_3b_2023296.nc
#-rw-rw-r-- 1 dfprod prod 1636356 Oct 24 00:35  rads_adt_6a_2023296.nc
#-rw-rw-r-- 1 dfprod prod  890028 Oct 24 00:35  rads_adt_c2_2023296.nc
#-rw-rw-r-- 1 dfprod prod 1500464 Oct 24 00:35  rads_adt_j3_2023296.nc
#-rw-rw-r-- 1 dfprod prod 1143488 Oct 24 00:35  rads_adt_sa_2023296.nc
#
#/lfs/h1/ops/prod/dcom/20231024/wgrdbul/adt:
#total 2556
#-rwxrwxr-x 1 dfprod prod    153 Oct 24 00:35 '^rads_adt.*297.nc$'
#-rwxrwxr-x 1 dfprod prod 448956 Oct 24 09:35  rads_adt_3a_2023297.nc
#-rwxrwxr-x 1 dfprod prod 431616 Oct 24 09:35  rads_adt_3b_2023297.nc
#-rwxrwxr-x 1 dfprod prod 615036 Oct 24 09:35  rads_adt_6a_2023297.nc
#-rwxrwxr-x 1 dfprod prod 672304 Oct 24 09:35  rads_adt_j3_2023297.nc
#-rwxrwxr-x 1 dfprod prod 432728 Oct 24 10:35  rads_adt_sa_2023297.nc
#
#[clogin03 /lfs/h2/emc/obsproc/noscrub/iliana.genkova/MARINE_code]$ date
#Tue Oct 24 19:47:08 UTC 2023
#
#OBSERVATIONS:
#-One file per day, with JD in the filename
#-The *ncoda* files are ready&final at 21:35 of the day of validity; We don't use these; 
#
#-The rads_adt_??_2023???.nc are FINALLIZED at 00:36 3 [THREE!!!] days later, 
# but we can't wait for 3 days. 
#-The rads_adt_??_2023???.nc get updated at 00:36 every day, it looks like,
# but ALSO at 09:35 (looking at it at 19:47 and 20:50 UTC) 
#


export Din=$DCOMROOT #/20231002/wgrdbul/adt 
#export Dout=/lfs/h2/emc/obsproc/noscrub/iliana.genkova/MARINE_code/
export Dout=/lfs/h2/emc/obsproc/noscrub/iliana.genkova/CRON/SOCA/com/obsproc/v1.2  #gfs.20231026/00/atmos/

# IG
# date2jday.sh 20231006
# 2023279
# and the oposite will work too!
# date2jday.sh 2023279
# 20231006

#cdate=20231017 # how does the script loop over dates? it doesn't - this is a simple day-processing script
               # the date can be a read-in input parameter, i.e.: create_ADT_6-hourly_dumps.sh `date +\%Y\%m\%d`
	       # or could be in here: cdate=`date +\%Y\%m\%d`
	     
#may be useful if latency is too big
#cdate=`date -d "$cdate -3 day" +%Y%m%d`
#cdatem1=`date -d "$cdate -4 day" +%Y%m%d`

## for testing only
#cdate=20231129

cdate=`date +\%Y\%m\%d`
cdatem1=`date -d "$cdate -1 day" +%Y%m%d`

echo 'YYYYMMDD cdate= cdatem1='
echo $cdate $cdatem1

for cyc in 00 06 12 18; do

echo 'cyc is= '$cyc

mkdir -p $Dout/gdas.$cdate/$cyc/adt
ls $Dout/gdas.$cdate/$cyc/adt
cycdatem3h=`date -d "$cdate $cyc -3 hours" +%Y%m%d%H`
cycdatep3h=`date -d "$cdate $cyc +3 hours" +%Y%m%d%H`

echo 'YYYYMMDDHH cycdatem3h=  cycdatep3h= ' $cycdatem3h $cycdatep3h
echo 'So far so good.......'

if [[ $cyc == '00' ]]; then
   #correction for 00: point to $cdatem1 
   cycdatem3h=`date -d "$cdatem1 $cyc -3 hours" +%Y%m%d%H`

   lofm3=`ls $Din/${cdatem1}/wgrdbul/adt/rads_adt_??_*`
   for file in $lofm3; do
       #if printf '%s' "$file" | grep -qz 'ncoda'; then #not needed, see _??_ in "ls" command
       #   break
       #fi
       echo 'file is: ' $file
       #sdatem1=`echo $file | cut -d'_' -f4 |  cut -c1-7` #fails on *coda* filenames
       sdatem1=`echo $file |tail -c 11 | cut -c1-7`
       #echo 'LETS SEE sdatem1: ' $sdatem1
       
       yyyymmddHMm1=`date2jday.sh $sdatem1`0000 # ${sdatem1:0:8}${sdatem1:9:2}${sdatem1:11:2}

       #echo 'LETS SEE yyyymmddHMm1: ' $yyyymmddHMm1
       #echo 'Lets see comparative : ' $cycdatem3h'00'
       if [[ $yyyymmddHMm1 -ge $cycdatem3h'00' ]]; then
          cp $file $Dout/gdas.$cdate/$cyc/adt/.
	  #echo 'we have a hit'
	  #ll $file
       fi
   done
   lof=`ls $Din/${cdate}/wgrdbul/adt/rads_adt_??_*`
   for file in $lof; do
       #if printf '%s' "$file" | grep -qz 'ncoda'; then
       #   break
       #fi
       #echo 'file is: ' $file
       #sdate=`echo $file | cut -d'_' -f4 | cut -c1-7`
       sdate=`echo $file |tail -c 11 | cut -c1-7`
       #echo 'LETS SEE sdate: ' $sdate

       yyyymmddHM=`date2jday.sh $sdate` # ${sdate:0:8}${sdate:9:2}${sdate:11:2}
       
       #echo 'LETS SEE yyyymmddHM: ' $yyyymmddHM

       if [[ $yyyymmddHM -le $cycdatep3h ]]; then

       cp $file $Dout/gdas.$cdate/$cyc/adt/.
       #ll  $file
       fi
   done
else
   lof=`ls $Din/${cdate}/wgrdbul/adt/rads_adt_??_*`
   for file in $lof; do
       #if printf '%s' "$file" | grep -qz 'ncoda'; then
       #   break
       #fi
       #echo 'file is: ' $file
       #sdate=`echo $file | cut -d'_' -f4 | cut -c1-7`
       sdate=`echo $file |tail -c 11 | cut -c1-7`
       #echo 'LETS SEE sdate: ' $sdate

       yyyymmddHM=`date2jday.sh $sdate`0000 # ${sdate:0:8}${sdate:9:2}${sdate:11:2}

       #echo 'LETS SEE yyyymmddHM(2nd): ' $yyyymmddHM
       #echo 'LETS SEE cycdatem3h: ' $cycdatem3h'00'
       #echo 'LETS SEE cycdatep3h: ' $cycdatep3h'00'

      #if [[ $yyyymmddHM -ge $cycdatem3h'00' && $yyyymmddHM -le $cycdatep3h'00' ]]; then #Use this if ADT filenames have HH
       if [[ $yyyymmddHM -ge $cdate'0000' && $yyyymmddHM -le $cdate'0000' ]]; then
          cp $file $Dout/gdas.$cdate/$cyc/adt/.
	  #ll $file
       fi
   done
fi #cyc==00
echo ' '
echo cycle $cyc DONE
echo ' '
done #cyc
